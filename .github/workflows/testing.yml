name: Integration Tests

on:
  push:
    branches: [ "feature/Assignment02" ]

jobs:
  run-spring-boot:
    name: Run Spring Boot and Test
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout code
        uses: actions/checkout@v3

      # Install Java JDK version 17
      - name: Install Java 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin

      # Setup PostgreSQL
      - name: Setup PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install postgresql postgresql-contrib
          sudo systemctl start postgresql.service

      # Start Spring Boot and run integration tests
      - name: Run Spring Boot
        run: |
          ./gradlew bootRun -Dspring.datasource.url=jdbc:postgresql://localhost:5432/webapp -Dspring.datasource.username=postgres -Dspring.datasource.password=${{secrets.DB_PASSWORD}} -Dspring.datasource.driver-class-name=org.postgresql.Driver -Dspring.jpa.hibernate.ddl-auto=update -Dspring.datasource.hikari.connection-timeout=20000 &
          sleep 60
          ./gradlew test
